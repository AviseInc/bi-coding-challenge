# Setup

## Start Docker Containers

There is a compose config to startup a Postgres DB (schema: public, db: data) and a localstack instance

```bash
docker compose up -d
```

## Install Packages

```bash
pnpm install
```

## Environment file

Create a `.env` file. You can copy the `.env.example` file and fill in the values.

## Startup the Dev Environment

The recommend way to finish setup is by running the guided setup:

```bash
pnpm run initial-setup
```

A quick guide to the most common commands and when you should run them:

* `pnpm install` - Every time you `git pull`
* `pnpm exec prisma generate` - Any time `schema/prisma.schema` changes (also when _you_ have changed it on your
  development branch!)
* `pnpm migrate-local` - Any time `migrations/` changes (also when you wrote a migration yourself you want to apply)
* `docker compose down && docker compose pull && docker compose up -d` - Any time there have been updates to other
  containers in the stack
* `pnpm generate-data` - Fill the empty DB with fake data

# Running The Backend

Start API service

Run

```
pnpm run start:dev
```

to start the API. Making changes to a file will cause a recompile and restart.

# Other Goodies

## Formatting

We format our code with Prettier and enforce code formatting on pull requests. To format your code, run:

```bash
pnpm fix:format
```

## Linting

We use ESLint to enforce some style decisions and require that all code merged to `main` passes linting rules.
To check your code, run:

```bash
pnpm check:lint
```

Sometimes, errors are automatically fixable. You can opt in to fixing your linting errors by running:

```bash
pnpm fix:lint
```

## Pre-Commit Checks

To run all the checks (formating and linting) run:

```bash
pnpm check
```

## Changing The Database Schema

When you want to change the database schema, you need to write some SQL that changes the schema to its new desired
state. This is called a **migration** or **database migration**.

To create a migration, run:

```
pnpm run create-migration NAME
```

where `NAME` is a descriptive name for what the migration does.

This command creates three files:

- A JavaScript file.
    - A generated file to run your up and down. Do not edit this file.
- A SQL "up" file.
    - This file is where you write the changes you want to make to the schema as SQL code.
- A SQL "down" file.
    - This file is where you write the _inverse_ of the changes you want to make to the schema as SQL code.
    - The idea of this file is that it can be used to roll back your migration in if needed once deployed.

You can then run `pnpm run migrate-local` to apply your migration, and `pnpm run migrate-down-one` to roll it back.

When you change the database schema, you also need to edit the `schema/prisma.schema` file so Prisma knows about your
changes. See the next section!

## Changing The Prisma Schema

Changes to the database schema in a migration will almost always be accompanied by edits to the `prisma/schema.prisma` (
or Prisma Schema) file. Think of this file as a description of what the schema looks like now, while the migration files
are essentially a long list of commands needed to get the
schema to its current state.

The [official documentation](https://www.prisma.io/docs/concepts/components/prisma-schema/data-model) is an extremely
useful resource for writing Prisma schemas.

Anytime you change the Prisma Schema, you need to re-run `npx prisma generate` to re-generate the Prisma Client and use
these changes from your API code.

## Resetting Your Local Database

So, you messed up. You dun goofed. You absolutely wrecked your local data. It's ok, it happens to all of us. This is
going to perform a reset on your Postgres DB and migrate to the latest schema. All data is destroyed:

```bash
pnpm run reset-db
```

